CLASS Solution  
    FUNCTION subsequencesWithMiddleMode(nums)  
        SET MOD TO one billion plus seven  
        SET ans TO zero  
        SET p TO an empty counter mapping elements to counts  
        SET s TO a counter mapping elements of nums to counts  

        FUNCTION nC2(n)  
            RETURN n MULTIPLIED BY n MINUS one DIVIDED BY two  
        END FUNCTION

        SET pss TO zero  
        SET spp TO zero  
        SET pp TO zero  
        SET ss TO the sum of the squares of each frequency in s  
        SET ps TO zero  

        FOR i FROM zero TO length of nums MINUS one  
            SET a TO element at position i of nums  
            
            INCREMENT pss BY p at a MULTIPLIED BY negative of s at a squared PLUS s at a minus one squared  
            INCREMENT spp BY negative p at a squared  
            INCREMENT ss BY negative s at a squared PLUS s at a minus one squared  
            INCREMENT ps BY negative p at a  
            
            DECREMENT s at a BY one

            SET l TO i  
            SET r TO length of nums MINUS i MINUS one  

            INCREMENT ans BY nC2 of l MULTIPLIED BY nC2 of r  
            DECREMENT ans BY nC2 of l MINUS p at a MULTIPLIED BY nC2 of r MINUS s at a  
            
            SET pss_ TO pss MINUS p at a MULTIPLIED BY s at a squared  
            SET spp_ TO spp MINUS s at a MULTIPLIED BY p at a squared  
            SET pp_ TO pp MINUS p at a squared  
            SET ss_ TO ss MINUS s at a squared  
            SET ps_ TO ps MINUS p at a MULTIPLIED BY s at a  
            SET p_ TO l MINUS p at a  
            SET s_ TO r MINUS s at a  

            DECREMENT ans BY ps_ MULTIPLIED BY p at a MULTIPLIED BY r MINUS s at a PLUS pss_ MULTIPLIED BY negative p at a  
            DECREMENT ans BY ps_ MULTIPLIED BY s at a MULTIPLIED BY l MINUS p at a PLUS spp_ MULTIPLIED BY negative s at a  
            DECREMENT ans BY (pp_ MINUS p_) MULTIPLIED BY s at a MULTIPLIED BY r MINUS s at a DIVIDED BY two  
            DECREMENT ans BY (ss_ MINUS s_) MULTIPLIED BY p at a MULTIPLIED BY l MINUS p at a DIVIDED BY two  
            
            SET ans TO ans MODULO MOD  

            INCREMENT pss BY s at a squared  
            INCREMENT spp BY s at a MULTIPLIED BY negative p at a squared PLUS p at a plus one squared  
            INCREMENT pp BY negative p at a squared PLUS p at a plus one squared  
            INCREMENT ps BY s at a  
            
            INCREMENT p at a BY one  
        END FOR  

        RETURN ans  
    END FUNCTION  
END CLASS