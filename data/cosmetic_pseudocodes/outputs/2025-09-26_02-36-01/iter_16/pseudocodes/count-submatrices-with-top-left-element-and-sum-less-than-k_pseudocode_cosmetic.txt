CLASS Solution
    FUNCTION countSubmatrices(grid, k)
      IF (NOT (grid IS NOT no_value)) OR (NOT ((element_at grid 0) IS NOT no_value))
        RETURN 0
      END IF

      SET x1 TO length_of(grid)
      SET y1 TO length_of(element_at grid 0)
      SET ps TO new_list_of_size_x1_each_with_list_of_size_y1_filled_with(0)
      SET res TO 0

      SET a TO 0
      WHILE a < x1
          SET b TO 0
          WHILE b < y1
              IF (a = 0) AND (b = 0)
                  SET temp1 TO element_at element_at grid a b
                  SET element_at element_at ps a b TO temp1
              ELSE
                  IF a = 0
                      SET temp2 TO element_at element_at ps a (b - 1)
                      SET temp3 TO element_at element_at grid a b
                      SET element_at element_at ps a b TO (temp2 + temp3)
                  ELSE
                      IF b = 0
                          SET temp4 TO element_at element_at ps (a - 1) b
                          SET temp5 TO element_at element_at grid a b
                          SET element_at element_at ps a b TO (temp4 + temp5)
                      ELSE
                          SET v1 TO element_at element_at ps (a - 1) b
                          SET v2 TO element_at element_at ps a (b - 1)
                          SET v3 TO element_at element_at ps (a - 1) (b - 1)
                          SET v4 TO element_at element_at grid a b
                          SET element_at element_at ps a b TO ((v1 + v2) - v3 + v4)
                      END IF
                  END IF
              END IF

              IF NOT (element_at element_at ps a b > k)
                  SET res TO (res + 1)
              END IF

              SET b TO (b + 1)
          END WHILE
          SET a TO (a + 1)
      END WHILE

      RETURN res
    END FUNCTION
END CLASS