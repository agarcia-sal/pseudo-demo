CLASS Solution  
    FUNCTION maxOperations(nums)  
        FUNCTION dfs(a, b, x, cache)  
            IF a GREATER THAN_OR_EQUAL b THEN  
                RETURN 0  
            END IF  
            IF (a, b, x) IN cache THEN  
                RETURN cache[(a, b, x)]  
            END IF  
            SET result TO 0  
            IF nums[a] PLUS nums[a PLUS 1] EQUALS x THEN  
                SET result TO MAX(result, 1 PLUS dfs(a PLUS 2, b, x, cache))  
            END IF  
            IF nums[b] PLUS nums[b MINUS 1] EQUALS x THEN  
                SET result TO MAX(result, 1 PLUS dfs(a, b MINUS 2, x, cache))  
            END IF  
            IF nums[a] PLUS nums[b] EQUALS x THEN  
                SET result TO MAX(result, 1 PLUS dfs(a PLUS 1, b MINUS 1, x, cache))  
            END IF  
            SET cache[(a, b, x)] TO result  
            RETURN result  
        END FUNCTION  
        SET p TO 1 PLUS dfs(2, LENGTH(nums) MINUS 1, nums[0] PLUS nums[1], {})  
        SET q TO 1 PLUS dfs(0, LENGTH(nums) MINUS 3, nums[LENGTH(nums) MINUS 1] MINUS 1 PLUS nums[LENGTH(nums) MINUS 1], {})  
        SET r TO 1 PLUS dfs(1, LENGTH(nums) MINUS 2, nums[0] PLUS nums[LENGTH(nums) MINUS 1], {})  
        RETURN MAXIMUM OF p, q, r  
    END FUNCTION  
END CLASS