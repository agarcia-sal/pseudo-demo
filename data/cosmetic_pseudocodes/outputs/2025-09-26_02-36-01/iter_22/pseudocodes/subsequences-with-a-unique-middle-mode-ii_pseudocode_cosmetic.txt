CLASS Solution
    FUNCTION subsequencesWithMiddleMode(nums)
        SET mod TO 1000000000 + 7
        SET gvhpnhy TO 0
        SET joxmzqae TO empty counter mapping elements to counts
        SET cgoxel TO counter mapping elements of nums to counts

        FUNCTION nC2(vyvncj)
            RETURN (vyvncj * (vyvncj - 1)) / 2
        END FUNCTION

        SET lbvpo TO 0
        SET vvjvk TO 0
        SET foxwe TO 0
        SET iosqkh TO 0
        FOR EACH lxpgow IN cgoxel VALUES
            SET iosqkh TO iosqkh + lxpgow * lxpgow
        END FOR
        SET sxmzs TO 0

        SET tztklp TO 0
        WHILE tztklp <= LENGTH(nums) - 1 DO
            SET vjhx TO nums[tztklp]

            SET lbvpo TO lbvpo + (joxmzqae[vjhx] * (- ((cgoxel[vjhx] * cgoxel[vjhx]) + (cgoxel[vjhx] - 1) * (cgoxel[vjhx] - 1))))
            SET vvjvk TO vvjvk - (joxmzqae[vjhx] * joxmzqae[vjhx])
            SET iosqkh TO iosqkh + ( - (cgoxel[vjhx] * cgoxel[vjhx]) + (cgoxel[vjhx] - 1) * (cgoxel[vjhx] - 1))
            SET sxmzs TO sxmzs - joxmzqae[vjhx]

            cgoxel[vjhx] = cgoxel[vjhx] - 1

            SET ydwwwx TO tztklp
            SET llrliv TO LENGTH(nums) - tztklp - 1

            SET gvhpnhy TO gvhpnhy + nC2(ydwwwx) * nC2(llrliv)
            SET gvhpnhy TO gvhpnhy - nC2(ydwwwx - joxmzqae[vjhx]) * nC2(llrliv - cgoxel[vjhx])

            SET lbvpo_ TO lbvpo - joxmzqae[vjhx] * (cgoxel[vjhx] * cgoxel[vjhx])
            SET vvjvk_ TO vvjvk - cgoxel[vjhx] * (joxmzqae[vjhx] * joxmzqae[vjhx])
            SET foxwe_ TO foxwe - (joxmzqae[vjhx] * joxmzqae[vjhx])
            SET iosqkh_ TO iosqkh - (cgoxel[vjhx] * cgoxel[vjhx])
            SET sxmzs_ TO sxmzs - joxmzqae[vjhx] * cgoxel[vjhx]
            SET p_ TO ydwwwx - joxmzqae[vjhx]
            SET s_ TO llrliv - cgoxel[vjhx]

            SET gvhpnhy TO gvhpnhy - sxmzs_ * joxmzqae[vjhx] * (llrliv - cgoxel[vjhx]) + lbvpo_ * (- joxmzqae[vjhx])
            SET gvhpnhy TO gvhpnhy - sxmzs_ * cgoxel[vjhx] * (ydwwwx - joxmzqae[vjhx]) + vvjvk_ * (- cgoxel[vjhx])
            SET gvhpnhy TO gvhpnhy - (foxwe_ - p_) * cgoxel[vjhx] * (llrliv - cgoxel[vjhx]) / 2
            SET gvhpnhy TO gvhpnhy - (iosqkh_ - s_) * joxmzqae[vjhx] * (ydwwwx - joxmzqae[vjhx]) / 2

            SET gvhpnhy TO gvhpnhy MOD mod

            SET lbvpo TO lbvpo + (cgoxel[vjhx] * cgoxel[vjhx])
            SET vvjvk TO vvjvk + (cgoxel[vjhx] * ( - (joxmzqae[vjhx] * joxmzqae[vjhx]) + (joxmzqae[vjhx] + 1) * (joxmzqae[vjhx] + 1)))
            SET foxwe TO foxwe + (- (joxmzqae[vjhx] * joxmzqae[vjhx]) + (joxmzqae[vjhx] + 1) * (joxmzqae[vjhx] + 1))
            SET sxmzs TO sxmzs + cgoxel[vjhx]

            SET joxmzqae[vjhx] TO joxmzqae[vjhx] + 1

            SET tztklp TO tztklp + 1
        END WHILE

        RETURN gvhpnhy
    END FUNCTION
END CLASS