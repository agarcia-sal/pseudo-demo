CLASS Solution  
    FUNCTION countNonDecreasingSubarrays(nums k)  
        SET m TO LENGTH(nums)  
        
        FUNCTION canMakeNonDecreasing(p q)  
            SET u TO 0  
            SET v TO nums[p]  
            
            SET w TO 1  
            WHILE w < q DO  
                IF nums[p + w] < v THEN  
                    SET u TO u + (v - nums[p + w])  
                END IF  
                IF v < nums[p + w] THEN  
                    SET v TO nums[p + w]  
                END IF  
                IF u > k THEN  
                    RETURN False  
                END IF  
                SET w TO w + 1  
            END WHILE  
            
            RETURN True  
        END FUNCTION  
        
        SET z TO m * ((m + 1) / 2)  
        SET r TO 0  
        
        SET s TO 0  
        WHILE s <= m - 1 DO  
            SET a TO 1  
            SET b TO m - s  
            WHILE a <= b DO  
                SET c TO (a + b) // 2  
                
                IF canMakeNonDecreasing(s c) = True THEN  
                    SET a TO c + 1  
                ELSE  
                    SET b TO c - 1  
                END IF  
            END WHILE  
            SET r TO r + (m - s - b)  
            SET s TO s + 1  
        END WHILE  
        
        RETURN z - r  
    END FUNCTION  
END CLASS