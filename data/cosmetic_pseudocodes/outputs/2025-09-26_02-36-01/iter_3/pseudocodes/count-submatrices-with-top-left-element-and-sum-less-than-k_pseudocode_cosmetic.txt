CLASS Solution
    FUNCTION countSubmatrices(grid, k)
        IF grid IS empty OR grid[0] IS empty THEN
            RETURN 0
        END IF
        SET rows TO LENGTH(grid)
        SET cols TO LENGTH(grid[0])
        SET sums TO ARRAY OF SIZE rows OF ARRAYS OF SIZE cols INITIALIZED TO 0
        SET total TO 0
        SET x TO 0
        WHILE x < rows DO
            SET y TO 0
            WHILE y < cols DO
                IF (x = 0) AND (y = 0) THEN
                    sums[x][y] ← grid[x][y]
                ELSE IF x = 0 THEN
                    sums[x][y] ← sums[x][y - 1] + grid[x][y]
                ELSE IF y = 0 THEN
                    sums[x][y] ← sums[x - 1][y] + grid[x][y]
                ELSE
                    temp1 ← sums[x][y - 1]
                    temp2 ← sums[x - 1][y]
                    temp3 ← sums[x - 1][y - 1]
                    sums[x][y] ← temp1 + temp2 - temp3 + grid[x][y]
                END IF
                IF sums[x][y] <= k THEN
                    total ← total + 1
                END IF
                y ← y + 1
            END WHILE
            x ← x + 1
        END WHILE
        RETURN total
    END FUNCTION
END CLASS