CLASS Solution
    FUNCTION resultGrid(image WITH TYPE List OF List OF integer threshold WITH TYPE integer) WITH RETURN TYPE List OF List OF integer
   SET fvnrec TO LENGTH OF image
   SET hkwzab TO LENGTH OF FIRST ELEMENT OF image
   SET vtqeuy TO EMPTY LIST

   SET klydri TO EMPTY LIST
   SET vucojb TO 0
   WHILE vucojb LESS THAN fvnrec
    SET cgmlxq TO 0
    SET dpudhf TO EMPTY LIST
    SET bnomfz TO EMPTY LIST
    WHILE cgmlxq LESS THAN hkwzab
      APPEND 0 TO bnomfz
      APPEND 0 TO dpudhf
      SET cgmlxq TO cgmlxq PLUS 1
    END WHILE
    APPEND bnomfz TO vtqeuy
    APPEND dpudhf TO klydri
    SET vucojb TO vucojb PLUS 1
   END WHILE

        FUNCTION is_valid_region(a Xz WITH TYPE integer b Kj WITH TYPE integer) WITH RETURN TYPE boolean
      SET ljryk TO 0
      SET cwxpit TO EMPTY FUNCTION(nuccgh WITH TYPE integer, gsberx WITH TYPE integer) WITH RETURN TYPE boolean
         IF nuccgh GREATER THAN OR EQUAL TO a Xz AND nuccgh LESS THAN a Xz PLUS 3 THEN
            IF gsberx GREATER THAN OR EQUAL TO b Kj AND gsberx LESS THAN b Kj PLUS 3 THEN
               RETURN True
            END IF
         END IF
         RETURN False
      END FUNCTION

      SET omoiji TO [(-1,0),(1,0),(0,-1),(0,1)]
      SET qdypwt TO a Xz
      WHILE qdypwt LESS THAN a Xz PLUS 3
         SET xsnjhg TO b Kj
         WHILE xsnjhg LESS THAN b Kj PLUS 3
            SET vfkxpr TO 0
            WHILE vfkxpr LESS THAN LENGTH OF omoiji
                SET dzclmn TO omoiji[vfkxpr][0]
                SET wytfzp TO omoiji[vfkxpr][1]
                SET nx TO qdypwt PLUS dzclmn
                SET ny TO xsnjhg PLUS wytfzp
                IF cwxpit(nx, ny) THEN
                   IF ABS(image[qdypwt][xsnjhg] MINUS image[nx][ny]) GREATER THAN threshold THEN
                    RETURN False
                   END IF
                END IF
                SET vfkxpr TO vfkxpr PLUS 1
            END WHILE
            SET xsnjhg TO xsnjhg PLUS 1
         END WHILE
       SET qdypwt TO qdypwt PLUS 1
      END WHILE
      RETURN True
        END FUNCTION

        FUNCTION calculate_average(o NO WITH TYPE integer p MCI WITH TYPE integer) WITH RETURN TYPE integer
      SET cibsxn TO 0
      SET ycngqa TO o NO
      REPEAT
         SET mnjavh TO p MCI
         REPEAT
            SET cibsxn TO cibsxn PLUS image[ycngqa][mnjavh]
            SET mnjavh TO mnjavh PLUS 1
         UNTIL mnjavh GREATER THAN OR EQUAL TO p MCI PLUS 3
         SET ycngqa TO ycngqa PLUS 1
      UNTIL ycngqa GREATER THAN OR EQUAL TO o NO PLUS 3
      SET mgebkc TO cibsxn DIVIDED BY (3 PLUS 3 PLUS 3 MINUS 6)
      RETURN mgebkc
        END FUNCTION

   SET ibvytu TO 0
   WHILE ibvytu LESS THAN fvnrec MINUS 2
     SET gflyzp TO 0
     WHILE gflyzp LESS THAN hkwzab MINUS 2
       IF is_valid_region(ibvytu gflyzp) EQUALS True THEN
           SET kpjcwr TO calculate_average(ibvytu gflyzp)
           SET ukgojv TO ibvytu
           WHILE ukgojv LESS THAN ibvytu PLUS 3
             SET wvkzrg TO gflyzp
             WHILE wvkzrg LESS THAN gflyzp PLUS 3
               SET vtqeuy[ukgojv][wvkzrg] TO vtqeuy[ukgojv][wvkzrg] PLUS kpjcwr
               SET klydri[ukgojv][wvkzrg] TO klydri[ukgojv][wvkzrg] PLUS 1
               SET wvkzrg TO wvkzrg PLUS 1
             END WHILE
             SET ukgojv TO ukgojv PLUS 1
           END WHILE
       END IF
       SET gflyzp TO gflyzp PLUS 1
     END WHILE
     SET ibvytu TO ibvytu PLUS 1
   END WHILE

   SET ykepid TO 0
   WHILE ykepid LESS THAN fvnrec
     SET meiruj TO 0
       WHILE meiruj LESS THAN hkwzab
          IF klydri[ykepid][meiruj] GREATER THAN 0 THEN
            SET vtqeuy[ykepid][meiruj] TO vtqeuy[ykepid][meiruj] DIVIDED BY klydri[ykepid][meiruj]
          ELSE
            SET vtqeuy[ykepid][meiruj] TO image[ykepid][meiruj]
          END IF
         SET meiruj TO meiruj PLUS 1
       END WHILE
     SET ykepid TO ykepid PLUS 1
   END WHILE
   RETURN vtqeuy
    END FUNCTION
END CLASS