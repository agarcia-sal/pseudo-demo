CLASS Solution
	FUNCTION countNonDecreasingSubarrays(nums k)
		SET m TO 0
		SET q TO LENGTH OF nums

		FUNCTION u(z y)
			SET A TO 0
			SET B TO nums[z]
			REPEAT
				IF nums[z + A] < B
					SET A TO A + 1
					SET C TO B - nums[z + A]
					SET B TO B
				ELSE
					SET C TO 0
					SET A TO A + 1
					SET B TO nums[z + A]
				END IF
				IF C + m > k
					RETURN False
				END IF
				SET m TO C + m
			UNTIL A = y - 1
			RETURN True
		END FUNCTION

		SET w TO q * (q + 1) / 2
		SET x TO 0

		SET r TO 0
		WHILE r <= q - 1
			SET s TO 1
			SET t TO q - r
			WHILE s <= t
				SET v TO (s + t) / 2
				IF u(r v) = True
					SET s TO v + 1
				ELSE
					SET t TO v - 1
				END IF
			END WHILE
			SET x TO x + q - r - t
			SET r TO r + 1
		END WHILE

		RETURN w - x
	END FUNCTION
END CLASS