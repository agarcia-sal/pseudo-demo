CLASS Solution
    FUNCTION countSubmatrices(grid, k)
        LET rows = LENGTH(grid)
        LET cols = LENGTH(grid[0])
        LET total = 0

        FUNCTION checkValues(matrix)
            FOR EACH line IN matrix DO
                FOR EACH item IN line DO
                    IF item > k THEN
                        RETURN False
                    END IF
                END FOR
            END FOR
            RETURN True
        END FUNCTION

        FUNCTION checkDescending(matrix)
            FOR EACH line IN matrix DO
                FOR idx FROM 1 TO LENGTH(line) - 1 DO
                    IF line[idx] > line[idx - 1] THEN
                        RETURN False
                    END IF
                END FOR
            END FOR
            RETURN True
        END FUNCTION

        FOR startRow FROM 0 TO rows - 1 DO
            FOR startCol FROM 0 TO cols - 1 DO
                FOR endRow FROM startRow TO rows - 1 DO
                    FOR endCol FROM startCol TO cols - 1 DO
                        LET extracted = []
                        FOR i FROM startRow TO endRow DO
                            LET segment = SLICE grid[i] FROM startCol TO endCol + 1
                            APPEND segment TO extracted
                        END FOR
                        IF checkValues(extracted) AND checkDescending(extracted) THEN
                            total = total + 1
                        END IF
                    END FOR
                END FOR
            END FOR
        END FOR

        RETURN total
    END FUNCTION
END CLASS