```
FUNCTION max_fill(grid, capacity)
    IMPORT math

    FUNCTION aggregate_rows(rows, accumulator)
        IF rows IS EMPTY THEN
            RETURN accumulator
        ELSE
            RETURN aggregate_rows(tail(rows), accumulator + head(rows))
        END IF
    END FUNCTION

    FUNCTION ceiling_division(value, cap)
        RETURN math ceiling(value / cap)
    END FUNCTION

    FUNCTION process_all_rows(matrices, acc)
        IF matrices IS EMPTY THEN
            RETURN acc
        ELSE
            LET current_row = head(matrices)
            LET row_sum = aggregate_rows(current_row, 0)
            LET row_fill = ceiling_division(row_sum, capacity)
            RETURN process_all_rows(tail(matrices), acc + row_fill)
        END IF
    END FUNCTION

    RETURN process_all_rows(grid, 0)
END FUNCTION
```